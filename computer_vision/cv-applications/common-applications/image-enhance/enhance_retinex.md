# Retinex 图像增强算法实现

## 基本原理    

图像增强方面我共研究了 Retinex、暗通道去雾、ACE 等算法。其实，它们都是共通的。甚至可以说，Retinex 和暗通道去雾就是同一个算法的两个不同视角，而 ACE 算法又是将Retinex 和灰度世界等白平衡理论相结合的产物。下面将依次讨论，每个算法写一个心得，欢迎拍砖。    

今天先写 Retinex。Retinex 理论认为，人眼观测到的图像 S 是光照图像 L 和物体反射图像 R 的乘积。而 R 才是真实的恒常性的图像，但是怎么从观测图像 S 中计算 R 呢？这是个病态问题，根本不可解。研究者就通过加以一定的约束条件，比如光照 L 具有缓变平滑性、L 与 S 有一定的弱相关性等等，然后估计出光照图像 L，进而得到 R。   

## 中心环绕算法估计   

从 S 中如何估计 L，就衍生出了各种各样的实现方式，影响较大的有：中心环绕、随机路径、变分、金字塔迭代等等方法。其中， ``中心环绕算法`` 无疑是影响最大的 retinex 实现方式，使用高斯尺度算子来估计光照图像，计算速度快。当然，它也有一些缺点：   
(1) 在强光阴影过渡区容易出现光晕现象；    
主要是由于高斯算子不能在过渡区很好的估计光照所致。    
(2) 对比较亮的图像处理欠佳，比如雾霾图像。    
主要原因有二：retinex 不是专门的去雾算法；对数化处理压缩了亮区域的显示范围，导致其细节弱化。   
由于 L 和 R 是乘积的关系，为了便于处理，一般对观测图像 S 先进行对数处理，这样就将乘积运算转换成了加法关系。使用对数处理可以极大的提升暗区域的像素值，以增加对比度，但代价是压缩了亮区图像的显示范围，导致其细节模糊甚至丢失。     
所以个人认为，retinex 适用于处理那些光照不足黑不拉几的图像，对于比较亮的图像，不妨先进行反色处理再 retinex。    
(3) 色彩保持能力较弱。   
因为对 rgb 三个颜色通道各自归一化处理的缘故，有论文提到了一些改善方法，但我发现还是不容乐观。      此外，三通道各自归一化处理后，其颜色均值是接近于 128 的，如果后面再跟一个指数化操作（对数处理的反操作），将导致图像颜色明显偏暗，所以这是一般 retinex 算法只有对数处理没有指数处理的缘故。    

## 改进中心环绕算法    

所以，我对 ``中心环绕算法`` 做了一点点改进：    

主要如下：
(1) 使用引导滤波来快速估计光照图像，减少光晕的出现，实验表明，该步骤对色彩保持能力也有一定的提升；  
(2) 在使用多个尺度算子进行合成的时候，不是简单的做均值处理；    
(3) 在完成 retinex 处理之后，再做一次简单的 gamma 校正，使其均值接近于 128。

下面给实验结果图, 可见色彩保持的还不错哦，对雾霾图像也有较好的效果。    

